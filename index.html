<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Couvert</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
    }
    #loading-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: white;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    #loading-screen img {
      width: 200px;
      animation: fadeIn 1s ease-in-out;
    }
    #loading-message {
      font-size: 18px;
      margin-top: 20px;
      color: #333;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.95); }
      to { opacity: 1; transform: scale(1); }
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    header img {
      height: 50px;
      margin-right: 20px;
    }
    h1 { font-size: 1.5em; }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[readonly] {
      background: #eee;
    }
    button {
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #34495e;
    }
    table {
      width: calc(100% - 40px);
      margin: 0 20px 20px;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 13px;
    }
    .pago { background: #c8f7c5; }
    .pendente { background: #f7c5c5; }
    .lancado { background: #fdf4c5; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    #filtros {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px 10px;
      gap: 10px;
    }

    #filtros select {
      padding: 8px;
      font-size: 14px;
    }

    #filtros button {
      width: auto;
      padding: 8px 16px;
      background: #2c3e50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }
    #filtros button:hover {
      background: #34495e;
    }

    @media (max-width: 768px) {
      #filtros {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>

  <!-- Tela de carregamento -->
  <div id="loading-screen">
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <p id="loading-message">Carregando...</p>
  </div>

  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <h1>Painel Couvert</h1>
  </header>

  <form id="form">
    <div><label>Mês</label><input type="text" name="mes" required></div>
    <div><label>Data</label><input type="date" name="data" required></div>
    <div><label>Profissional</label><input list="listaProfissionais" name="profissional" id="profissional" required><datalist id="listaProfissionais"></datalist></div>
    <div><label>Função</label><input type="text" name="funcao" id="funcao"></div>
    <div><label>Dados bancários / Pix</label><input type="text" name="dadosPix" id="dadosPix"></div>
    <div><label>Titular da Conta</label><input type="text" name="titularConta" id="titularConta"></div>
    <div><label>Tempo</label><input type="text" name="tempo"></div>
    <div><label>Valor acordado (R$)</label><input type="number" name="valorAcordado" id="valorAcordado"></div>
    <div><label>Bonificação (R$)</label><input type="number" name="bonificacao" id="bonificacao"></div>
    <div><label>Desconto de consumo (R$)</label><input type="number" name="desconto" id="desconto"></div>
    <div><label>Valor final (R$)</label><input type="number" name="valorFinal" id="valorFinal" readonly></div>
    <div><label>Data Pagamento</label><input type="date" name="dataPagamento"></div>
    <div><label>Status</label>
      <select name="status">
        <option value="PENDENTE">PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <div style="grid-column: span 3;">
      <button type="submit">Salvar</button>
    </div>
  </form>

  <div id="filtros">
    <div>
      <label>Filtrar por status:</label>
      <select id="filtroStatus">
        <option value="TODOS">TODOS</option>
        <option value="PENDENTE" selected>PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <button onclick="liquidarEmMassa()">Liquidar em Massa</button>
  </div>

  <table id="tabela">
    <thead>
      <tr><th>Data</th><th>Profissional</th><th>Função</th><th>Pix</th><th>Titular</th><th>Tempo</th><th>Valor Acordado</th><th>Bonificação</th><th>Desconto</th><th>Valor Final</th><th>Data Pagamento</th><th>Status</th><th>Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const URL = 'https://script.google.com/macros/s/AKfycbyUghvcMJlE5I0xmGzwBp9KpWLu9htIsNh3ixW_ghCS9aH8oKyC9nRbOVjhD1YeiqZj9Q/exec';
    const form = document.getElementById('form');
    const filtroStatus = document.getElementById('filtroStatus');
    let profissionais = [], dadosLancamentos = [];

    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date();
      const nomesMeses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      document.querySelector('input[name="mes"]').value = `${nomesMeses[hoje.getMonth()].charAt(0).toUpperCase() + nomesMeses[hoje.getMonth()].slice(1)} de ${hoje.getFullYear()}`;
      document.querySelector('input[name="data"]').value = hoje.toISOString().split('T')[0];
    });

    fetch(`${URL}?acao=profissionais`).then(res => res.json()).then(data => {
      profissionais = data;
      const lista = document.getElementById('listaProfissionais');
      lista.innerHTML = '';
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nome;
        lista.appendChild(opt);
      });
    });

   document.getElementById('profissional').addEventListener('input', () => {
  const nomeDigitado = profissional.value.trim().toUpperCase();
  const p = profissionais.find(p => p.nome.trim().toUpperCase() === nomeDigitado);

  if (p) {
    // Preenche e bloqueia
    funcao.value = p.funcao || '';
    dadosPix.value = p.pix || '';
    titularConta.value = p.titular || '';
    valorAcordado.value = p.valor || '';

    funcao.readOnly = true;
    dadosPix.readOnly = true;
    titularConta.readOnly = true;
    valorAcordado.readOnly = false;

    funcao.style.background = '#eee';
    dadosPix.style.background = '#eee';
    titularConta.style.background = '#eee';
    valorAcordado.style.background = '#eee';
  } else {
    // Limpa e desbloqueia
    funcao.value = '';
    dadosPix.value = '';
    titularConta.value = '';
    valorAcordado.value = '';

    funcao.readOnly = false;
    dadosPix.readOnly = false;
    titularConta.readOnly = false;
    valorAcordado.readOnly = false;

    funcao.style.background = '';
    dadosPix.style.background = '';
    titularConta.style.background = '';
    valorAcordado.style.background = '';
  }
});


    [valorAcordado, desconto].forEach(input => {
      input.addEventListener('input', () => {
        const v = parseFloat(valorAcordado.value) || 0;
        const d = parseFloat(desconto.value) || 0;
        valorFinal.value = (v - d).toFixed(2);
      });
    });

    form.addEventListener('submit', e => {
      e.preventDefault();

      const btn = form.querySelector('button[type="submit"]');
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');

      btn.disabled = true;
      btn.textContent = 'Salvando...';
      msg.textContent = 'Salvando dados...';
      loading.style.display = 'flex';

      const dados = Object.fromEntries(new FormData(form));
      dados.acao = 'adicionar';

      fetch(URL, {
        method: 'POST',
        body: JSON.stringify(dados)
      }).then(() => {
        form.reset();
        filtroStatus.value = 'PENDENTE';
        setTimeout(() => {
          btn.disabled = false;
          btn.textContent = 'Salvar';
          loading.style.display = 'none';
          carregarLancamentos();
        }, 1500);
      });
    });

    filtroStatus.addEventListener('change', carregarLancamentos);

    function carregarLancamentos() {
      fetch(`${URL}?acao=ler`).then(res => res.json()).then(data => {
        dadosLancamentos = data;
        const tbody = document.querySelector('#tabela tbody');
        tbody.innerHTML = '';
        const filtro = filtroStatus.value || 'PENDENTE';
        data.forEach(item => {
          if (filtro !== 'TODOS' && item.status !== filtro) return;
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', item.index);
          tr.className = item.status.toLowerCase();
          tr.innerHTML = `
            <td>${item.data?.split('T')[0] || ''}</td>
            <td>${item.profissional}</td>
            <td>${item.funcao || ''}</td>
            <td>${item.pix || ''}</td>
            <td>${item.titular || ''}</td>
            <td>${item.tempo || ''}</td>
            <td>R$ ${(item.valorAcordado || 0).toFixed(2)}</td>
            <td>R$ ${(item.bonificacao || 0).toFixed(2)}</td>
            <td>R$ ${(item.desconto || 0).toFixed(2)}</td>
            <td>R$ ${(item.valorFinal || 0).toFixed(2)}</td>
            <td>${item.dataPagamento || ''}</td>
            <td>
              <select onchange="atualizarStatus(this, ${item.index})">
                <option value="PENDENTE" ${item.status === 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
                <option value="LANÇADO" ${item.status === 'LANÇADO' ? 'selected' : ''}>LANÇADO</option>
                <option value="PAGO" ${item.status === 'PAGO' ? 'selected' : ''}>PAGO</option>
              </select>
            </td>
            <td><div class="actions">
              <button onclick="excluir(${item.index})">Excluir</button>
            </div></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function atualizarStatus(select, index) {
      const status = select.value;
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');

      msg.textContent = 'Atualizando status...';
      loading.style.display = 'flex';

      fetch(URL, {
        method: 'POST',
        body: JSON.stringify({ acao: 'atualizarStatus', index, status })
      }).then(() => {
        setTimeout(() => location.reload(), 1500);
      });
    }

    function excluir(index) {
      const senha = prompt("Digite a senha para excluir:");
      if (senha === '1234') {
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'excluir', index })
        }).then(() => {
          const linha = document.querySelector(`tr[data-index="${index}"]`);
          if (linha) linha.remove();
        });
      } else {
        alert("Senha incorreta.");
      }
    }

    function liquidarEmMassa() {
      const filtro = filtroStatus.value;
      if (filtro === 'TODOS' || filtro === 'PAGO') {
        alert("Selecione um status válido (PENDENTE ou LANÇADO) para liquidar.");
        return;
      }
      if (!confirm(`Deseja marcar todos os registros com status "${filtro}" como PAGO?`)) return;

      const promessas = dadosLancamentos.filter(item => item.status === filtro).map(item =>
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'atualizarStatus', index: item.index, status: 'PAGO' })
        })
      );
      Promise.all(promessas).then(() => {
        alert("Todos os registros foram atualizados para PAGO.");
        location.reload();
      });
    }

    window.addEventListener('load', () => {
      const loading = document.getElementById('loading-screen');
      const msg = document.getElementById('loading-message');
      msg.textContent = 'Carregando...';
      setTimeout(() => {
        loading.style.display = 'none';
        filtroStatus.value = 'PENDENTE';
        carregarLancamentos();
      }, 2000);
    });
  </script>
</body>
</html>
