<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel Couvert</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 0;
    }
    header {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      background: white;
      border-bottom: 1px solid #ccc;
    }
    header img {
      height: 50px;
      margin-right: 20px;
    }
    h1 { font-size: 1.5em; }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
    }
    label {
      font-weight: bold;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    input[readonly] {
      background: #eee;
    }
    button {
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #34495e;
    }
    table {
      width: calc(100% - 40px);
      margin: 0 20px 20px;
      border-collapse: collapse;
      background: white;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: left;
      font-size: 13px;
    }
    .pago { background: #c8f7c5; }
    .pendente { background: #f7c5c5; }
    .lancado { background: #fdf4c5; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }
    #filtros {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px 10px;
      gap: 10px;
    }
    @media (max-width: 768px) {
      #filtros {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <img src="https://static.wixstatic.com/media/d830b0_8cec50a98bbf4775814dbfa5386585e8~mv2.png" alt="Logo">
    <h1>Painel Couvert</h1>
  </header>
  <form id="form">
    <div><label>Mês</label><input type="text" name="mes" required></div>
    <div><label>Data</label><input type="date" name="data" required></div>
    <div><label>Profissional</label><input list="listaProfissionais" name="profissional" id="profissional" required><datalist id="listaProfissionais"></datalist></div>
    <div><label>Função</label><input type="text" name="funcao" id="funcao"></div>
    <div><label>Dados bancários / Pix</label><input type="text" name="dadosPix" id="dadosPix"></div>
    <div><label>Titular da Conta</label><input type="text" name="titularConta" id="titularConta"></div>
    <div><label>Tempo</label><input type="text" name="tempo"></div>
    <div><label>Valor acordado (R$)</label><input type="number" name="valorAcordado" id="valorAcordado"></div>
    <div><label>Bonificação (R$)</label><input type="number" name="bonificacao" id="bonificacao"></div>
    <div><label>Desconto de consumo (R$)</label><input type="number" name="desconto" id="desconto"></div>
    <div><label>Valor final (R$)</label><input type="number" name="valorFinal" id="valorFinal" readonly></div>
    <div><label>Data Pagamento</label><input type="date" name="dataPagamento"></div>
    <div><label>Status</label>
      <select name="status">
        <option value="PENDENTE">PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <div style="grid-column: span 3;"><button type="submit">Salvar</button></div>
  </form>
  <div id="filtros">
    <div>
      <label>Filtrar por status:</label>
      <select id="filtroStatus">
        <option value="TODOS">TODOS</option>
        <option value="PENDENTE" selected>PENDENTE</option>
        <option value="LANÇADO">LANÇADO</option>
        <option value="PAGO">PAGO</option>
      </select>
    </div>
    <button onclick="liquidarEmMassa()">Liquidar em Massa</button>
  </div>
  <table id="tabela">
    <thead><tr><th>Data</th><th>Profissional</th><th>Função</th><th>Pix</th><th>Titular</th><th>Tempo</th><th>Valor Acordado</th><th>Bonificação</th><th>Desconto</th><th>Valor Final</th><th>Data Pagamento</th><th>Status</th><th>Ações</th></tr></thead>
    <tbody></tbody>
  </table>
  <script>
    const URL = 'https://script.google.com/macros/s/AKfycbwkcNQPRYtTBAFd1mTg-mMx0DpAvwUNS2WXFNF2B9oOfGlYa-FbCftb9Ju4N7Cozxjydw/exec';
    const form = document.getElementById('form');
    const filtroStatus = document.getElementById('filtroStatus');
    let profissionais = [], dadosLancamentos = [];

    document.addEventListener('DOMContentLoaded', () => {
      const hoje = new Date();
      const nomesMeses = ['janeiro','fevereiro','março','abril','maio','junho','julho','agosto','setembro','outubro','novembro','dezembro'];
      document.querySelector('input[name="mes"]').value = `${nomesMeses[hoje.getMonth()].charAt(0).toUpperCase() + nomesMeses[hoje.getMonth()].slice(1)} de ${hoje.getFullYear()}`;
      document.querySelector('input[name="data"]').value = hoje.toISOString().split('T')[0];
    });

    fetch(`${URL}?acao=profissionais`).then(res => res.json()).then(data => {
      profissionais = data;
      const lista = document.getElementById('listaProfissionais');
      lista.innerHTML = '';
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.nome;
        lista.appendChild(opt);
      });
    });

    document.getElementById('profissional').addEventListener('input', () => {
      const p = profissionais.find(p => p.nome === profissional.value);
      if (p) {
        funcao.value = p.funcao || '';
        dadosPix.value = p.pix || '';
        titularConta.value = p.titular || '';
        valorAcordado.value = p.valor || '';
      }
    });

    [valorAcordado, bonificacao, desconto].forEach(input => {
      input.addEventListener('input', () => {
        const v = parseFloat(valorAcordado.value) || 0;
        const b = parseFloat(bonificacao.value) || 0;
        const d = parseFloat(desconto.value) || 0;
        valorFinal.value = (v - b - d).toFixed(2);
      });
    });

    form.addEventListener('submit', e => {
      e.preventDefault();
      const dados = Object.fromEntries(new FormData(form));
      dados.acao = 'adicionar';
      fetch(URL, {
        method: 'POST',
        body: JSON.stringify(dados)
      }).then(() => {
        alert('Salvo com sucesso!');
        form.reset();
        filtroStatus.value = 'PENDENTE';
        carregarLancamentos();
      });
    });

    filtroStatus.addEventListener('change', carregarLancamentos);

    function carregarLancamentos() {
      fetch(`${URL}?acao=ler`).then(res => res.json()).then(data => {
        dadosLancamentos = data;
        const tbody = document.querySelector('#tabela tbody');
        tbody.innerHTML = '';
        const filtro = filtroStatus.value || 'PENDENTE';
        data.forEach(item => {
          if (filtro !== 'TODOS' && item.status !== filtro) return;
          const tr = document.createElement('tr');
          tr.setAttribute('data-index', item.index);
          tr.className = item.status.toLowerCase();
          tr.innerHTML = `
            <td>${item.data?.split('T')[0] || ''}</td>
            <td>${item.profissional}</td>
            <td>${item.funcao || ''}</td>
            <td>${item.pix || ''}</td>
            <td>${item.titular || ''}</td>
            <td>${item.tempo || ''}</td>
            <td>R$ ${(item.valorAcordado || 0).toFixed(2)}</td>
            <td>R$ ${(item.bonificacao || 0).toFixed(2)}</td>
            <td>R$ ${(item.desconto || 0).toFixed(2)}</td>
            <td>R$ ${(item.valorFinal || 0).toFixed(2)}</td>
            <td>${item.dataPagamento || ''}</td>
            <td>${item.status}</td>
            <td><div class="actions">
              <button onclick="alterarStatus(${item.index})">Status</button>
              <button onclick="excluir(${item.index})">Excluir</button>
            </div></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    function alterarStatus(index) {
      const btn = document.querySelectorAll('.actions')[index].querySelector('button');
      const textoOriginal = btn.textContent;
      btn.textContent = 'Processando...';
      btn.disabled = true;

      fetch(URL, {
        method: 'POST',
        body: JSON.stringify({ acao: 'status', index })
      }).then(() => {
        carregarLancamentos();
      }).finally(() => {
        btn.textContent = textoOriginal;
        btn.disabled = false;
      });
    }

    function excluir(index) {
      const senha = prompt("Digite a senha para excluir:");
      if (senha === '1234') {
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'excluir', index })
        }).then(() => {
          const linha = document.querySelector(`tr[data-index="${index}"]`);
          if (linha) linha.remove();
        });
      } else {
        alert("Senha incorreta.");
      }
    }

    function liquidarEmMassa() {
      const filtro = filtroStatus.value;
      if (filtro === 'TODOS' || filtro === 'PAGO') {
        alert("Selecione um status válido (PENDENTE ou LANÇADO) para liquidar.");
        return;
      }
      if (!confirm(`Deseja marcar todos os registros com status "${filtro}" como PAGO?`)) return;

      const promessas = dadosLancamentos.filter(item => item.status === filtro).map(item =>
        fetch(URL, {
          method: 'POST',
          body: JSON.stringify({ acao: 'status', index: item.index })
        })
      );
      Promise.all(promessas).then(() => {
        alert("Todos os registros foram atualizados para PAGO.");
        carregarLancamentos();
      });
    }

    window.onload = () => {
      filtroStatus.value = 'PENDENTE';
      carregarLancamentos();
    };
  </script>
</body>
</html>
