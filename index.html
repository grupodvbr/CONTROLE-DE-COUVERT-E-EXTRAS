<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Couvert - CB Systems</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
    header { display: flex; align-items: center; padding: 10px 20px; background: white; border-bottom: 1px solid #ccc; }
    header img { height: 40px; margin-right: 10px; }
    header h1 { font-size: 1.5em; color: #222; }

    form, .table-container {
      max-width: 900px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    label { display: block; margin-top: 12px; font-weight: bold; }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    input[readonly] {
      background: #eee;
      font-weight: bold;
    }

    button {
      margin-top: 20px;
      padding: 12px 20px;
      background-color: #1a237e;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover { background-color: #0d155d; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #ccc;
    }

    th {
      background: #1a237e;
      color: white;
    }

    .btn-status, .btn-excluir {
      padding: 5px 10px;
      font-size: 0.8em;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-status { background: orange; color: white; }
    .btn-excluir { background: red; color: white; }
  </style>
</head>
<body>

<header>
  <img src="caeaf5a7-e255-4dbc-8429-6654e27c2cc4.png" alt="Logo CB Systems">
  <h1>Controle de Couvert</h1>
</header>

<form id="couvertForm">
  <label>Mês</label><input type="month" name="mes" required>
  <label>Data</label><input type="date" name="data" required>
  <label>Profissional</label><input type="text" name="profissional" required>
  <label>Função</label><input type="text" name="funcao">
  <label>Dados bancários / Pix</label><input type="text" name="dadosPix">
  <label>Tempo</label><input type="text" name="tempo">
  <label>Valor acordado</label><input type="number" step="0.01" name="valorAcordado" id="valorAcordado" required>
  <label>Bonificação</label><input type="number" step="0.01" name="bonificacao" id="bonificacao">
  <label>Desconto de Consumo</label><input type="number" step="0.01" name="desconto" id="desconto">
  <label>Valor (automático)</label><input type="text" name="valorFinal" id="valorFinal" readonly>
  <label>Data pagamento</label><input type="date" name="dataPagamento">
  <label>Status</label>
  <select name="status">
    <option value="PENDENTE">PENDENTE</option>
    <option value="PAGO">PAGO</option>
  </select>
  <button type="submit">Cadastrar</button>
</form>

<div class="table-container">
  <h2>Lançamentos Registrados</h2>
  <table id="tabelaCouvert">
    <thead>
      <tr>
        <th>Profissional</th>
        <th>Data</th>
        <th>Valor</th>
        <th>Status</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxgRM60nkFIJ8C-itktSePSWDFmT7_OSPTceS7Mb-lLjVHL-S6GFlc_vl5V5oapFPqptA/exec';
  const senhaExclusao = '1234';

  const valorAcordado = document.getElementById('valorAcordado');
  const bonificacao = document.getElementById('bonificacao');
  const desconto = document.getElementById('desconto');
  const valorFinal = document.getElementById('valorFinal');
  const form = document.getElementById('couvertForm');
  const botao = form.querySelector('button[type="submit"]');

  function formatarReal(valor) {
    return `R$ ${Number(valor).toFixed(2).replace('.', ',')}`;
  }

  function atualizarValorFinal() {
    const v1 = parseFloat(valorAcordado.value) || 0;
    const v2 = parseFloat(bonificacao.value) || 0;
    const v3 = parseFloat(desconto.value) || 0;
    const resultado = v1 - v2 - v3;
    valorFinal.value = formatarReal(resultado);
    valorFinal.dataset.valorNumerico = resultado.toFixed(2);
  }

  [valorAcordado, bonificacao, desconto].forEach(el => el.addEventListener('input', atualizarValorFinal));
  atualizarValorFinal();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    botao.disabled = true;
    botao.innerText = 'Processando...';

    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => {
      data[key] = key === 'valorFinal'
        ? document.getElementById('valorFinal').dataset.valorNumerico || "0"
        : value;
    });
    data.acao = 'adicionar';

    try {
      const resposta = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'application/json' }
      });

      if (resposta.ok) {
        alert("✅ Registro salvo com sucesso!");
        form.reset();
        atualizarValorFinal();
        carregarLancamentos();
      } else {
        alert("❌ Erro ao salvar. Verifique a planilha ou script.");
      }
    } catch (erro) {
      alert("❌ Erro de conexão. Tente novamente.");
      console.error(erro);
    }

    botao.disabled = false;
    botao.innerText = 'Cadastrar';
  });

  async function carregarLancamentos() {
    try {
      const res = await fetch(scriptURL + '?acao=ler');
      const data = await res.json();
      const tbody = document.querySelector('#tabelaCouvert tbody');
      tbody.innerHTML = '';
      data.forEach((item, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.profissional}</td>
          <td>${item.data}</td>
          <td>${formatarReal(item.valorFinal)}</td>
          <td>${item.status}</td>
          <td>
            <button class="btn-status" onclick="alterarStatus(${i})">Alterar</button>
            <button class="btn-excluir" onclick="excluir(${i})">Excluir</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (e) {
      console.error('Erro ao carregar lançamentos:', e);
    }
  }

  async function alterarStatus(index) {
    await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify({ acao: 'status', index }),
      headers: { 'Content-Type': 'application/json' }
    });
    carregarLancamentos();
  }

  async function excluir(index) {
    const senha = prompt("Digite a senha para excluir:");
    if (senha !== senhaExclusao) return alert("Senha incorreta!");
    await fetch(scriptURL, {
      method: 'POST',
      body: JSON.stringify({ acao: 'excluir', index }),
      headers: { 'Content-Type': 'application/json' }
    });
    carregarLancamentos();
  }

  carregarLancamentos();
</script>
